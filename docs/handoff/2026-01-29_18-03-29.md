# Handoff — 2026-01-29 18:03:29

## Summary
This repo now provisions Phase 1 via OpenTofu/libvirt and configures VMs via Ansible. Inventory is generated from tofu outputs and libvirt DHCP leases. Core OpenSpec changes for OpenTofu, network modes, Ansible, and smoke tests are complete. One remaining change (`devex-hygiene`) has tasks listed but not checked off, even though much of it is already implemented.

## Key decisions (ADRs)
- `docs/adr/0001-libvirt-mgmt-mode-user.md`: MGMT_MODE=user maps to libvirt NAT + DHCP lease discovery (no hostfwd).
- `docs/adr/0002-inventory-contract.md`: Inventory contract fields and schema versioning.

## OpenSpec status (as of this handoff)
- `swarm-lab-opentofu-libvirt`: complete
- `swarm-lab-network-modes`: complete
- `ansible-integration`: complete
- `platformqa-smoke-tests`: complete
- `phase1-high-value-components`: complete
- `devex-hygiene`: in-progress (tasks not checked)

## What’s already implemented
- **OpenTofu infra**: `infra/` with libvirt module and cloud-init templates.
- **Tofu tooling**: `scripts/tofu/run.sh` and `scripts/tofu/inventory.sh` with schema validation.
- **Ansible subsystem**: `ansible/` structure, roles, playbooks, inventory generator, Make targets.
- **Network modes**: `MGMT_MODE=user|bridge` and runbook `docs/runbooks/network-modes.md`.
- **Ops helpers**: host network setup script, collect-logs script, secrets policy, inventory schema doc.
- **Smoke tests**: Make targets `smoke`, `smoke-idempotent`, `test-matrix` and runbook.
- **CI hygiene**: `.github/workflows/ci.yml` with shellcheck + tofu fmt/validate.

## Gaps / next steps
1) **Finish `devex-hygiene` change**
   - The change has tasks but they are still unchecked. Most items appear implemented: doctor/clean/reset, snapshot/restore, standards doc, CI workflow, placeholder specs.
   - Action: mark tasks complete in `openspec/changes/devex-hygiene/tasks.md` and run `openspec status --change devex-hygiene`.

2) **Apply next OpenSpec change for Phase 1 high-value components**
   - Specs/skills/scripts are already added. Confirm the inventory contract acceptance tests align with tooling.

3) **Consider updating cloud-init spec in `openspec/changes/ansible-integration`**
   - Cloud-init templates are now minimal; spec file was modified accordingly.

## Useful commands
```bash
openspec list --json
openspec status --change "swarm-lab-opentofu-libvirt"
make lab-up
make lab-status
make ansible-inventory
make ansible-baseline ansible-docker ansible-swarm
make ansible-verify
```
