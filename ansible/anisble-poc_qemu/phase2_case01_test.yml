---
- name: Phase 2 Case 01 test (services + VM connectivity)
  hosts: swarm_managers
  become: true
  gather_facts: false
  vars:
    stack_name: phase2-linux-usable
    case_prefix: case01
    svc_web: "{{ stack_name }}_{{ case_prefix }}-web"
    svc_ping: "{{ stack_name }}_{{ case_prefix }}-ping"
    vm_service: "{{ stack_name }}_vm-runner-linux"
    vm_linux_ips: "{{ vm_linux_ips | default([]) }}"
  tasks:
    - name: Ensure case01 services exist
      ansible.builtin.command: docker service ls --format '{{ "{{.Name}}" }}'
      register: svc_names
      changed_when: false

    - name: Assert case01 services are present
      ansible.builtin.assert:
        that:
          - svc_web in svc_names.stdout_lines
          - svc_ping in svc_names.stdout_lines
        fail_msg: "Missing case01 services. Run case01 up first."

    - name: Get node for case01-ping task
      ansible.builtin.command: >
        docker service ps {{ svc_ping }}
        --filter desired-state=running
        --format '{{ "{{.Node}}" }}'
      register: ping_nodes
      changed_when: false

    - name: Ensure case01-ping task is running
      ansible.builtin.assert:
        that:
          - ping_nodes.stdout_lines | length > 0
        fail_msg: "case01-ping has no running tasks."

    - name: Resolve case01-ping container id on its node
      ansible.builtin.command: >
        docker ps --filter label=com.docker.swarm.service.name={{ svc_ping }}
        --format '{{ "{{.ID}}" }}'
      register: ping_container
      changed_when: false
      delegate_to: "{{ ping_nodes.stdout_lines[0] }}"

    - name: Ensure case01-ping container exists
      ansible.builtin.assert:
        that:
          - ping_container.stdout | length > 0
        fail_msg: "case01-ping container not found on node {{ ping_nodes.stdout_lines[0] }}."

    - name: Ping case01-web from case01-ping container
      ansible.builtin.command: >
        docker exec {{ ping_container.stdout }}
        ping -c 1 {{ case_prefix }}-web
      register: ping_result
      changed_when: false
      delegate_to: "{{ ping_nodes.stdout_lines[0] }}"

    - name: HTTP check from case01-ping to case01-web
      ansible.builtin.command: >
        docker exec {{ ping_container.stdout }}
        /bin/sh -c "wget -qO- http://{{ case_prefix }}-web >/dev/null"
      register: http_check
      changed_when: false
      delegate_to: "{{ ping_nodes.stdout_lines[0] }}"

    - name: Show service connectivity results
      ansible.builtin.debug:
        msg:
          - "case01-ping -> case01-web ping rc: {{ ping_result.rc | default('n/a') }}"
          - "case01-ping -> case01-web http rc: {{ http_check.rc | default('n/a') }}"

    - name: Ensure vm-runner service is running
      ansible.builtin.command: docker service ps {{ vm_service }} --filter desired-state=running --format '{{ "{{.ID}}" }}'
      register: vm_runner_tasks
      changed_when: false

    - name: Assert vm-runner has a running task
      ansible.builtin.assert:
        that:
          - vm_runner_tasks.stdout | length > 0
        fail_msg: "vm-runner-linux container not running."

    - name: Require Linux VM IPs for L2 validation
      ansible.builtin.assert:
        that:
          - vm_linux_ips | length > 0
        fail_msg: "Provide vm_linux_ips (e.g., vm_linux_ips=['192.168.123.50']) to validate L2 connectivity."

    - name: L2 connectivity check from node to VM (ping + SSH port)
      ansible.builtin.command: >
        docker run --rm --network host alpine:3.19
        /bin/sh -c "ping -c 1 {{ item }} && nc -z -w 3 {{ item }} 22"
      loop: "{{ vm_linux_ips }}"
      register: vm_l2_checks
      changed_when: false

    - name: Show VM L2 connectivity results
      ansible.builtin.debug:
        msg: "L2 check for {{ item.item }} rc={{ item.rc | default('n/a') }}"
      loop: "{{ vm_l2_checks.results }}"
