---
- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Select package list
  ansible.builtin.set_fact:
    common_packages: "{{ common_packages_debian if ansible_facts.os_family == 'Debian' else common_packages_redhat }}"

- name: Install baseline packages
  ansible.builtin.package:
    name: "{{ common_packages }}"
    state: present

- name: Ensure time sync package
  ansible.builtin.package:
    name: "{{ common_timesync_package }}"
    state: present

- name: Select KVM package list
  ansible.builtin.set_fact:
    kvm_packages: "{{ kvm_packages_debian if ansible_facts.os_family == 'Debian' else kvm_packages_redhat }}"
  when: install_kvm_tools | bool

- name: Install KVM tooling (optional)
  ansible.builtin.package:
    name: "{{ kvm_packages }}"
    state: present
  when: install_kvm_tools | bool

- name: Check /dev/kvm availability
  ansible.builtin.stat:
    path: /dev/kvm
  register: kvm_device

- name: Report /dev/kvm status
  ansible.builtin.debug:
    msg: "/dev/kvm present: {{ kvm_device.stat.exists | default(false) }}"
