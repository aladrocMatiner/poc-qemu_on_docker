---
- name: Check swarm state
  ansible.builtin.command: !unsafe docker info --format '{{.Swarm.LocalNodeState}}'
  register: swarm_state
  changed_when: false

- name: Init swarm on first manager
  ansible.builtin.shell: |
    if [ -n "{{ swarm_advertise_addr }}" ]; then
      docker swarm init --advertise-addr {{ swarm_advertise_addr }}
    else
      docker swarm init
    fi
  when: inventory_hostname == groups['swarm_managers'][0] and swarm_state.stdout != 'active'

- name: Get worker join token
  ansible.builtin.command: docker swarm join-token -q worker
  register: worker_token
  changed_when: false
  run_once: true
  delegate_to: "{{ groups['swarm_managers'][0] }}"

- name: Join workers
  ansible.builtin.command: >
    docker swarm join --token {{ hostvars[groups['swarm_managers'][0]].worker_token.stdout }}
    {{ hostvars[groups['swarm_managers'][0]].ansible_host | default(groups['swarm_managers'][0]) }}:2377
  when: inventory_hostname in groups['swarm_workers'] and swarm_state.stdout != 'active'

- name: Check /dev/kvm on each node
  ansible.builtin.stat:
    path: /dev/kvm
  register: kvm_device

- name: Apply vm-capable labels from manager
  ansible.builtin.command: >
    docker node update
    {{ '--label-add vm-capable=true' if (hostvars[item].kvm_device.stat.exists | default(false)) else '--label-rm vm-capable' }}
    {{ item }}
  loop: "{{ groups['swarm_managers'] + groups['swarm_workers'] }}"
  run_once: true
  delegate_to: "{{ groups['swarm_managers'][0] }}"

- name: Build node label targets
  ansible.builtin.set_fact:
    swarm_label_targets: "{{ swarm_label_targets | default([]) + [ {
      'name': item,
      'index': (item | regex_search('node(\\d+)$', '\\1') | default('0', true)),
      'role': ('manager' if item in groups['swarm_managers'] else 'worker')
    } ] }}"
  loop: "{{ groups['swarm_managers'] + groups['swarm_workers'] }}"
  run_once: true

- name: Apply node identity labels
  ansible.builtin.command: >
    docker node update
    --label-add node-index={{ item.index }}
    --label-add node-name={{ item.name }}
    --label-add node-role={{ item.role }}
    {{ item.name }}
  loop: "{{ swarm_label_targets }}"
  run_once: true
  delegate_to: "{{ groups['swarm_managers'][0] }}"
