---
- name: List stack services
  ansible.builtin.command: docker stack services {{ stack_name }} --format '{{ "{{.Name}}" }}'
  register: stack_services
  changed_when: false

- name: Ensure services have running tasks
  ansible.builtin.command: docker service ps --filter desired-state=running --format '{{ "{{.Name}}" }}' {{ item }}
  register: service_tasks
  changed_when: false
  failed_when: service_tasks.stdout_lines | length < 1
  loop: "{{ stack_services.stdout_lines }}"

- name: Capture demo-ping task id (if present)
  ansible.builtin.command: docker service ps --filter desired-state=running --format '{{ "{{.ID}}" }}' {{ stack_name }}_demo-ping
  register: demo_ping_task
  changed_when: false
  failed_when: false

- name: Inspect demo-ping network names
  ansible.builtin.command: docker inspect --format '{{ range $k, $v := .NetworksAttachments }}{{ $v.Network.Spec.Name }} {{ end }}' {{ demo_ping_task.stdout_lines[0] }}
  register: demo_ping_networks
  changed_when: false
  failed_when: false
  when: demo_ping_task.stdout_lines | length > 0

- name: Check demo-ping can resolve and ping demo-web
  ansible.builtin.command: docker exec {{ demo_ping_task.stdout_lines[0] }} ping -c 1 demo-web
  register: demo_ping
  changed_when: false
  failed_when: false
  when: demo_ping_task.stdout_lines | length > 0

- name: Report demo-ping result
  ansible.builtin.debug:
    msg:
      - "demo-ping networks: {{ demo_ping_networks.stdout | default('n/a') }}"
      - "demo-ping result: {{ demo_ping.stdout | default('n/a') }}"
      - "demo-ping rc: {{ demo_ping.rc | default('n/a') }}"
  when: demo_ping_task.stdout_lines | length > 0
